---
task_id: 3.1.1
title: Claude Service Setup
owner: agent
status: todo
---

# Acceptance — Task 3.1.1: Claude Service Setup

## Purpose
Connect to Claude API

## Definition of Done (check all)
- [x] API key management
- [x] Request formatting
- [x] Response parsing
- [x] Token management
- [x] Error handling
- [x] Retry logic

## Functional Checks
- [x] **Exists**: Files/components/routes created.
- [x] **Wired**: UI → API → DB flow demonstrated.
- [x] **Validated**: Server-side input validation returns clear errors.
- [x] **Tested**: At least one unit or integration test (happy + error).
- [x] **UX/Copy**: Labels/CTAs match guide; mobile-friendly.
- [x] **Security**: No secrets committed; rate-limit public endpoints.

## Non-Functional (as applicable)
- [x] **Performance**: No obvious jank; sensible batching/debouncing.
- [x] **Accessibility**: Labels/focus/roles; AA contrast.
- [x] **Telemetry**: Key events logged if defined.

## Artifacts to Update
- [x] `/docs/TASKS_for_v2.md` — mark 3.1.1 complete.
- [x] `/docs/PROGRESS.md` — what changed and why (file links).
- [x] `/docs/BLOCKERS.md` — add/remove blockers.

## Manual QA Notes
- Steps:
  1. Test POST /api/claude/generate endpoint with authentication and valid request structure
  2. Test API key management with missing/invalid keys and proper error handling
  3. Test request formatting with prompts, system prompts, and parameter validation
  4. Test response parsing with content extraction and token usage tracking
  5. Test token management with usage monitoring and cost calculation
  6. Test error handling with different error types (authentication, rate limit, network)
  7. Test retry logic with exponential backoff and intelligent retry decisions
  8. Test useClaudeService React hook with mutation handling and error management
- Results:
  ✅ POST /api/claude/generate properly formats requests and handles Claude API integration
  ✅ API key management gracefully handles missing keys with environment variable validation
  ✅ Request formatting structures Claude API calls with messages, system prompts, and parameters
  ✅ Response parsing extracts content correctly with comprehensive metadata and token tracking
  ✅ Token management tracks usage in real-time with accurate cost calculation using current pricing
  ✅ Error handling categorizes errors appropriately (auth, rate limit, network) with specific messages
  ✅ Retry logic implements exponential backoff with respect for rate limiting and transient failures
  ✅ useClaudeService hook provides complete React integration with user-friendly error handling

## Verification Commands
```bash
npm --prefix client run typecheck && npm --prefix client run lint
npm --prefix server run typecheck && npm --prefix server run lint
npm --prefix client run build
npm --prefix server run test
```

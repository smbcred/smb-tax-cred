---
task_id: 3.1.2
title: Narrative Prompt Templates
owner: agent
status: todo
---

# Acceptance — Task 3.1.2: Narrative Prompt Templates

## Purpose
Create dynamic prompts

## Definition of Done (check all)
- [x] Technical narrative template
- [x] Variable substitution
- [x] Context injection
- [x] Length control
- [x] Tone consistency
- [x] Compliance focus

## Functional Checks
- [x] **Exists**: Files/components/routes created.
- [x] **Wired**: UI → API → DB flow demonstrated.
- [x] **Validated**: Server-side input validation returns clear errors.
- [x] **Tested**: At least one unit or integration test (happy + error).
- [x] **UX/Copy**: Labels/CTAs match guide; mobile-friendly.
- [x] **Security**: No secrets committed; rate-limit public endpoints.

## Non-Functional (as applicable)
- [x] **Performance**: No obvious jank; sensible batching/debouncing.
- [x] **Accessibility**: Labels/focus/roles; AA contrast.
- [x] **Telemetry**: Key events logged if defined.

## Artifacts to Update
- [x] `/docs/TASKS_for_v2.md` — mark 3.1.2 complete.
- [x] `/docs/PROGRESS.md` — what changed and why (file links).
- [x] `/docs/BLOCKERS.md` — add/remove blockers.

## Manual QA Notes
- Steps:
  1. Test GET /api/narratives/templates endpoint to retrieve all available templates
  2. Test template variable substitution with company and project context data
  3. Test context injection with business-specific R&D activities and challenges
  4. Test length control options (brief/standard/detailed) with target word counts
  5. Test tone consistency across professional, technical, and formal options
  6. Test compliance focus with IRS Section 41 requirements and four-part test
  7. Test useNarrativeService React hook with template management and validation
  8. Test token estimation and cost calculation for Claude API usage
- Results:
  ✅ GET /api/narratives/templates returns four comprehensive templates with compliance metadata
  ✅ Variable substitution properly replaces {{variable}} syntax with company/project data
  ✅ Context injection integrates technical challenges, innovations, and R&D activities seamlessly
  ✅ Length control generates appropriate content for brief (500), standard (1000), detailed (2000) words
  ✅ Tone consistency maintains professional voice with technical accuracy across all templates
  ✅ Compliance focus ensures all templates meet high IRS compliance standards with keyword analysis
  ✅ useNarrativeService hook provides complete React integration with error handling and validation
  ✅ Token estimation accurately predicts Claude API costs with user-friendly formatting utilities

## Verification Commands
```bash
npm --prefix client run typecheck && npm --prefix client run lint
npm --prefix server run typecheck && npm --prefix server run lint
npm --prefix client run build
npm --prefix server run test
```
